<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="WRIMSv2" name="Create Standalone Runnable Jar for WRIMSv2">

	<target name="WRIMSv2" depends="Clean_files, Build_Info, Build_jar_zip">

		<echo message="Finish WRIMS v2" />
		
	</target>

	<target name="Clean_files" >
		<echo message="Running Clean_Files" />
		<delete file="bin/wrimsv2/version.props"/>
		<delete dir="jar_out"/>
		<delete file="zip_out/*.zip"/>
		<delete dir="zip_out"/>
		<mkdir dir="jar_out"/>
		<mkdir dir="zip_out"/>
	</target>
	
	<target name="Build_Info">
	    <tstamp>
	        <format property="builtat" pattern="MM/dd/yyyy hh:mm aa" timezone="America/Los_Angeles"/>
	    </tstamp>        
	   <!-- <exec executable="svnversion" outputproperty="svnversion"/> -->
		<exec executable="git" outputproperty="git.revision" failifexecutionfails="false" errorproperty="">
		        <arg value="describe"/>
		        <arg value="--tags"/>
		        <arg value="--always"/>
		        <arg value="HEAD"/>
		</exec>
		
	    <exec executable="whoami" outputproperty="whoami"/>
	   <!-- <exec executable="uname" outputproperty="buildsystem"><arg value="-a"/></exec> -->

	    <propertyfile file="bin/wrimsv2/version.props"
	        comment="This file is automatically generated - DO NOT EDIT">        
	        <entry key="buildtime" value="${builtat}"/>
	        <entry key="vn" value="${git.revision}"/>
	        <entry key="builder" value="${whoami}"/>
	        <entry key="system" value="${buildsystem}"/>
	    </propertyfile>
		
		<echo message="Version: ${git.revision}"/>
		
	</target>

	<target name="Build_jar_zip" >

		<available file="bin/wrimsv2/version.props" property="version_file.present" />
		<fail>
			<condition>
				<not>
					<isset property="version_file.present" />
				</not>
			</condition>
		</fail>

		<echo message="Running Build_jar_zip" />

		<jar destfile="jar_out/WRIMSv2.jar" filesetmanifest="mergewithoutmain">
			<manifest>
				<attribute name="Main-Class" value="wrimsv2.components.Controller"/>
				<attribute name="Class-Path" value="."/>
			</manifest>
			<fileset dir="bin">
				<include name="wrimsv2/**/*.class"/>
				<include name="wrimsv2/version.props"/>
				<exclude name="**/*.g"/>
			</fileset>
			<zipfileset excludes="META-INF/*.SF" src="src/wrimsv2/lib/antlr-3.5.2-runtime.jar"/>
		</jar>

		<zip destfile="zip_out/WRIMSv2.zip"  basedir="jar_out" />

		<available file="zip_out/WRIMSv2.zip" property="zip_file.present" />
		<fail>
			<condition>
				<not>
					<isset property="zip_file.present" />
				</not>
			</condition>
		</fail>
		
		<echo message="Finished Build_jar_zip" />

	</target>

</project>
